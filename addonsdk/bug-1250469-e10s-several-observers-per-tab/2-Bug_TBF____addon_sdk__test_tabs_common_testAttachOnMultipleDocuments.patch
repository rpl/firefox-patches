# HG changeset patch
# User Luca Greco <lgreco@mozilla.com>
# Date 1457639001 -3600
#      Thu Mar 10 20:43:21 2016 +0100
# Node ID 744ca34a40d4aa1ab45c0788cb96419abc5bdaa3
# Parent  9c6149b99e81e61fad34bf5f77a64f25b01483db
Bug TBF - [addon-sdk] test-tabs-common testAttachOnMultipleDocuments

MozReview-Commit-ID: Dxw7GusNOcR

diff --git a/addon-sdk/source/lib/sdk/content/worker.js b/addon-sdk/source/lib/sdk/content/worker.js
--- a/addon-sdk/source/lib/sdk/content/worker.js
+++ b/addon-sdk/source/lib/sdk/content/worker.js
@@ -158,23 +158,22 @@ connect.define(Worker, function(worker, 
 detach.define(Worker, function(worker) {
   let model = modelFor(worker);
   if (!model.attached)
     return;
 
   processes.port.off('sdk/worker/event', worker.receive);
   model.attached = false;
   model.destroyed = true;
-  emit(worker, 'detach');
 });
 
 isPrivate.define(Worker, ({ tab }) => isPrivate(tab));
 
 // Something in the parent side has destroyed the worker, tell the child to
 // detach, the child will respond when it has detached
 destroy.define(Worker, function(worker, reason) {
   let model = modelFor(worker);
-  model.destroyed = true;
-  if (!model.attached)
+  if (!model.attached || model.destroyed)
     return;
 
+  model.destroyed = true;
   worker.send('detach', reason);
 });
