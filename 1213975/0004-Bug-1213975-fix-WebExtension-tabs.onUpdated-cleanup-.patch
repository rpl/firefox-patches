# HG changeset patch
# User Luca Greco <luca.greco@alcacoop.it>

Bug 1213975 - fix WebExtension tabs.onUpdated cleanup on context close (r=billm)

---
 browser/components/extensions/ext-tabs.js  | 17 +++++++++++++----
 browser/components/extensions/ext-utils.js |  2 +-
 2 files changed, 14 insertions(+), 5 deletions(-)

diff --git a/browser/components/extensions/ext-tabs.js b/browser/components/extensions/ext-tabs.js
index e73ea0a..c56b4a3 100644
--- a/browser/components/extensions/ext-tabs.js
+++ b/browser/components/extensions/ext-tabs.js
@@ -202,25 +202,34 @@ extensions.registerAPI((extension, context) => {
               url: locationURI.spec
             });
             if (needed) {
               fire(tabId, changeInfo, TabManager.convert(extension, tab));
             }
           },
         };
 
+        let onClose = {
+          close: () => {
+            context.forgetOnClose(onClose);
+            AllWindowEvents.removeListener("progress", progressListener);
+            AllWindowEvents.removeListener("TabAttrModified", listener);
+            AllWindowEvents.removeListener("TabPinned", listener);
+            AllWindowEvents.removeListener("TabUnpinned", listener);
+          }
+        };
+        context.callOnClose(onClose);
+
         AllWindowEvents.addListener("progress", progressListener);
         AllWindowEvents.addListener("TabAttrModified", listener);
         AllWindowEvents.addListener("TabPinned", listener);
         AllWindowEvents.addListener("TabUnpinned", listener);
+
         return () => {
-          AllWindowEvents.removeListener("progress", progressListener);
-          AllWindowEvents.addListener("TabAttrModified", listener);
-          AllWindowEvents.addListener("TabPinned", listener);
-          AllWindowEvents.addListener("TabUnpinned", listener);
+          onClose.close();
         };
       }).api(),
 
       onReplaced: ignoreEvent(),
 
       onRemoved: new EventManager(context, "tabs.onRemoved", fire => {
         let tabListener = event => {
           let tab = event.originalTarget;
diff --git a/browser/components/extensions/ext-utils.js b/browser/components/extensions/ext-utils.js
index 193a4a2..8d1f26a 100644
--- a/browser/components/extensions/ext-utils.js
+++ b/browser/components/extensions/ext-utils.js
@@ -271,17 +271,17 @@ global.AllWindowEvents = {
     if (type == "domwindowopened") {
       return WindowListManager.removeOpenListener(listener);
     } else if (type == "domwindowclosed") {
       return WindowListManager.removeCloseListener(listener);
     }
 
     let listeners = this._listeners.get(type);
     listeners.delete(listener);
-    if (listeners.length == 0) {
+    if (listeners.size == 0) {
       this._listeners.delete(type);
       if (this._listeners.size == 0) {
         WindowListManager.removeOpenListener(this.openListener);
       }
     }
 
     let e = Services.wm.getEnumerator("navigator:browser");
     while (e.hasMoreElements()) {

