# HG changeset patch
# User Luca Greco <lgreco@mozilla.com>

Bug 1227462 - Test tabs.create URLs. r=kmag

---
 .../components/extensions/test/browser/browser.ini |  1 +
 .../browser/browser_ext_tabs_create_invalid_url.js | 65 ++++++++++++++++++++++
 2 files changed, 66 insertions(+)
 create mode 100644 browser/components/extensions/test/browser/browser_ext_tabs_create_invalid_url.js

diff --git a/browser/components/extensions/test/browser/browser.ini b/browser/components/extensions/test/browser/browser.ini
index a40494a..95afee4 100644
--- a/browser/components/extensions/test/browser/browser.ini
+++ b/browser/components/extensions/test/browser/browser.ini
@@ -20,16 +20,17 @@ support-files =
 [browser_ext_popup_api_injection.js]
 [browser_ext_contextMenus.js]
 [browser_ext_getViews.js]
 [browser_ext_tabs_executeScript_good.js]
 [browser_ext_tabs_executeScript_bad.js]
 [browser_ext_tabs_query.js]
 [browser_ext_tabs_getCurrent.js]
 [browser_ext_tabs_create.js]
+[browser_ext_tabs_create_invalid_url.js]
 [browser_ext_tabs_update.js]
 [browser_ext_tabs_update_url.js]
 [browser_ext_tabs_onUpdated.js]
 [browser_ext_tabs_sendMessage.js]
 [browser_ext_tabs_move.js]
 [browser_ext_tabs_move_window.js]
 [browser_ext_windows_update.js]
 [browser_ext_contentscript_connect.js]
diff --git a/browser/components/extensions/test/browser/browser_ext_tabs_create_invalid_url.js b/browser/components/extensions/test/browser/browser_ext_tabs_create_invalid_url.js
new file mode 100644
index 0000000..d405616
--- /dev/null
+++ b/browser/components/extensions/test/browser/browser_ext_tabs_create_invalid_url.js
@@ -0,0 +1,65 @@
+/* -*- Mode: indent-tabs-mode: nil; js-indent-level: 2 -*- */
+/* vim: set sts=2 sw=2 et tw=80: */
+"use strict";
+
+function* testTabsCreateInvalidURL(tabsCreateURL) {
+  let extension = ExtensionTestUtils.loadExtension({
+    manifest: {
+      "permissions": ["tabs"],
+    },
+
+    background: function() {
+      browser.test.sendMessage("ready");
+      browser.test.onMessage.addListener((msg, tabsCreateURL) => {
+        browser.tabs.create({ url: tabsCreateURL }, (tab) => {
+          // TODO: check runtime.lastError once supported
+          browser.test.assertEq(undefined, tab, "on error tab should be undefined");
+
+          // Remove the opened tab is any.
+          if (tab) {
+            browser.tabs.remove(tab.id);
+          }
+          browser.test.sendMessage("done");
+        });
+      });
+    },
+  });
+
+  yield extension.startup();
+
+  yield extension.awaitMessage("ready");
+
+  info(`test tab.create on invalid URL "${tabsCreateURL}"`);
+
+  extension.sendMessage("start", tabsCreateURL);
+  yield extension.awaitMessage("done");
+
+  yield extension.unload();
+}
+
+add_task(function* () {
+  info("Start testing tabs.create on invalid URLs");
+
+  let dataURLPage = `
+    data:text/html,<!DOCTYPE html>
+    <html>
+      <head>
+        <meta charset="utf-8">
+      </head>
+      <body>
+        <h1>data url page</h1>
+      </body>
+    </html>`;
+
+  let testCases = [
+    { tabsCreateURL: "about:addons" },
+    { tabsCreateURL: "javascript:console.log('tabs.update execute javascript')" },
+    { tabsCreateURL: dataURLPage },
+  ];
+
+  for (let { tabsCreateURL } of testCases) {
+    yield* testTabsCreateInvalidURL(tabsCreateURL);
+  }
+
+  info("done");
+});

