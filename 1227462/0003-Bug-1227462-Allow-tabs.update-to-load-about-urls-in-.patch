# HG changeset patch
# User Luca Greco <luca.greco@alcacoop.it>

Bug 1227462 - Allow tabs.update to load "about:" urls in existent tabs. r=kmag

---
 browser/components/extensions/ext-tabs.js                             | 3 ++-
 browser/components/extensions/test/browser/browser_ext_tabs_update.js | 2 +-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/browser/components/extensions/ext-tabs.js b/browser/components/extensions/ext-tabs.js
index c5bd26f..a80a14f 100644
--- a/browser/components/extensions/ext-tabs.js
+++ b/browser/components/extensions/ext-tabs.js
@@ -326,17 +326,18 @@ extensions.registerSchemaAPI("tabs", null, (extension, context) => {
         }
       },
 
       update: function(tabId, updateProperties, callback) {
         let tab = tabId !== null ? TabManager.getTab(tabId) : TabManager.activeTab;
         let tabbrowser = tab.ownerDocument.defaultView.gBrowser;
 
         if (updateProperties.url !== null) {
-          if (context.checkLoadURL(updateProperties.url)) {
+          let uri = Services.io.newURI(updateProperties.url, null, null);
+          if (uri.scheme == "about" || context.checkLoadURL(updateProperties.url)) {
             tab.linkedBrowser.loadURI(updateProperties.url);
           } else {
             // TODO: runtime.lastError should be set
             Cu.reportError(`Permission denied on tabs.update an url to the target tab ${tabId}`);
           }
         }
         if (updateProperties.active !== null) {
           if (updateProperties.active) {
diff --git a/browser/components/extensions/test/browser/browser_ext_tabs_update.js b/browser/components/extensions/test/browser/browser_ext_tabs_update.js
index ff947b3..3ef8d65 100644
--- a/browser/components/extensions/test/browser/browser_ext_tabs_update.js
+++ b/browser/components/extensions/test/browser/browser_ext_tabs_update.js
@@ -133,17 +133,17 @@ add_task(function* () {
       expectedError: false,
     },
     {
       tabsUpdateURL: "self",
       expectedError: false,
     },
     {
       tabsUpdateURL: "about:addons",
-      expectedError: true,
+      expectedError: false,
     },
     {
       tabsUpdateURL: "javascript:console.log('tabs.update execute javascript')",
       expectedError: true,
     },
     {
       tabsUpdateURL: "data:text/html,<h1>data url page</h1>",
       expectedError: true,

