# HG changeset patch
# User Luca Greco <lgreco@mozilla.com>

Bug 1227462 - tabs.update should call checkLoadURL. r=kmag

---
 browser/components/extensions/ext-tabs.js | 24 ++++++++++++++++++++++--
 1 file changed, 22 insertions(+), 2 deletions(-)

diff --git a/browser/components/extensions/ext-tabs.js b/browser/components/extensions/ext-tabs.js
index f724d8f..8301259 100644
--- a/browser/components/extensions/ext-tabs.js
+++ b/browser/components/extensions/ext-tabs.js
@@ -318,34 +318,54 @@ extensions.registerSchemaAPI("tabs", null, (extension, context) => {
         if (callback) {
           runSafe(context, callback);
         }
       },
 
       update: function(tabId, updateProperties, callback) {
         let tab = tabId !== null ? TabManager.getTab(tabId) : TabManager.activeTab;
         let tabbrowser = tab.ownerDocument.defaultView.gBrowser;
+
+        if (!tab) {
+          // TODO: runtime.lastError should be set to `No tab with id: ${tabId}`
+          if (callback) {
+            runSafe(context, callback, undefined);
+          }
+          return;
+        }
+
         if (updateProperties.url !== null) {
-          tab.linkedBrowser.loadURI(updateProperties.url);
+          if (context.checkLoadURL(updateProperties.url)) {
+            tab.linkedBrowser.loadURI(updateProperties.url);
+          } else {
+            // TODO: runtime.lastError should be set to `Invalid url: ${updateProperties.url}`
+            if (callback) {
+              runSafe(context, callback, undefined);
+            }
+            return;
+          }
         }
+
+        // FIXME: highlighted/selected, muted, openerTabId
+
         if (updateProperties.active !== null) {
           if (updateProperties.active) {
             tabbrowser.selectedTab = tab;
           } else {
             // Not sure what to do here? Which tab should we select?
           }
         }
+
         if (updateProperties.pinned !== null) {
           if (updateProperties.pinned) {
             tabbrowser.pinTab(tab);
           } else {
             tabbrowser.unpinTab(tab);
           }
         }
-        // FIXME: highlighted/selected, muted, openerTabId
 
         if (callback) {
           runSafe(context, callback, TabManager.convert(extension, tab));
         }
       },
 
       reload: function(tabId, reloadProperties, callback) {
         let tab = tabId !== null ? TabManager.getTab(tabId) : TabManager.activeTab;

