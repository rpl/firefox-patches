# HG changeset patch
# User Luca Greco <luca.greco@alcacoop.it>

Bug 1214658 - add test case of an webextension page iframe created from a content script r=kmag

---
 .../mochitest/file_ext_collect_security_errors.js  |  10 ++
 .../extensions/test/mochitest/mochitest.ini        |   2 +
 .../test_ext_contentscript_create_iframe.html      | 188 +++++++++++++++++++++
 3 files changed, 200 insertions(+)
 create mode 100644 toolkit/components/extensions/test/mochitest/file_ext_collect_security_errors.js
 create mode 100644 toolkit/components/extensions/test/mochitest/test_ext_contentscript_create_iframe.html

diff --git a/toolkit/components/extensions/test/mochitest/file_ext_collect_security_errors.js b/toolkit/components/extensions/test/mochitest/file_ext_collect_security_errors.js
new file mode 100644
index 0000000..8974d4b
--- /dev/null
+++ b/toolkit/components/extensions/test/mochitest/file_ext_collect_security_errors.js
@@ -0,0 +1,10 @@
+"use strict";
+
+Components.utils.import("resource://gre/modules/Services.jsm");
+
+Services.console.registerListener(function listener(message) {
+  if (/Security Error: Content at (.*) may not load or link to (.*)/.test(message.message)) {
+    Services.console.unregisterListener(listener);
+    sendAsyncMessage("security-error-message", { message: message.message });
+  }
+});
diff --git a/toolkit/components/extensions/test/mochitest/mochitest.ini b/toolkit/components/extensions/test/mochitest/mochitest.ini
index f1364ed..678e286 100644
--- a/toolkit/components/extensions/test/mochitest/mochitest.ini
+++ b/toolkit/components/extensions/test/mochitest/mochitest.ini
@@ -17,21 +17,23 @@ support-files =
   file_script_bad.js
   file_script_redirect.js
   file_script_xhr.js
   file_sample.html
   redirection.sjs
   file_privilege_escalation.html
   file_ext_background_api_injection.js
   file_permission_xhr.html
+  file_ext_collect_security_errors.js
 
 [test_ext_simple.html]
 [test_ext_geturl.html]
 [test_ext_contentscript.html]
 skip-if = buildapp == 'b2g' # runat != document_idle is not supported.
+[test_ext_contentscript_create_iframe.html]
 [test_ext_i18n_css.html]
 [test_ext_generate.html]
 [test_ext_localStorage.html]
 [test_ext_onmessage_removelistener.html]
 [test_ext_notifications.html]
 [test_ext_permission_xhr.html]
 skip-if = buildapp == 'b2g' # JavaScript error: jar:remoteopenfile:///data/local/tmp/generated-extension.xpi!/content.js, line 46: NS_ERROR_ILLEGAL_VALUE:
 [test_ext_runtime_connect.html]
diff --git a/toolkit/components/extensions/test/mochitest/test_ext_contentscript_create_iframe.html b/toolkit/components/extensions/test/mochitest/test_ext_contentscript_create_iframe.html
new file mode 100644
index 0000000..26367ed
--- /dev/null
+++ b/toolkit/components/extensions/test/mochitest/test_ext_contentscript_create_iframe.html
@@ -0,0 +1,188 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <title>Test for content script</title>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SpawnTask.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/ExtensionTestUtils.js"></script>
+  <script type="text/javascript" src="head.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+</head>
+<body>
+
+<!-- WORKAROUND: this textarea hack is used to contain the html page source without escaping it -->
+<textarea id="test-asset">
+  <!DOCTYPE HTML>
+  <html>
+    <head>
+      <meta charset="utf-8">
+      <script type="text/javascript" src="content_script_iframe.js"></script>
+    </head>
+  </html>
+</textarea>
+
+<script type="text/javascript">
+"use strict";
+
+add_task(function* test_contentscript_create_iframe() {
+  function backgroundScript() {
+    browser.runtime.onMessage.addListener((msg, sender) => {
+      let { name, availableAPIs, manifest } = msg;
+      let hasExtTabsAPI = availableAPIs.indexOf("tabs") > 0;
+      let hasExtWindowsAPI = availableAPIs.indexOf("windows") > 0;
+
+      browser.test.assertFalse(hasExtTabsAPI, "the created iframe should not be able to use privileged APIs (tabs)");
+      browser.test.assertFalse(hasExtWindowsAPI, "the created iframe should not be able to use privileged APIs (windows)");
+
+      browser.test.assertTrue(
+        JSON.stringify(manifest) == JSON.stringify(chrome.runtime.getManifest()),
+        "the add-on manifest should be accessible from the created iframe"
+      );
+
+      browser.test.sendMessage(name);
+    });
+  }
+
+  function contentScript() {
+    let failToLoadIframe = document.createElement("iframe");
+    failToLoadIframe.setAttribute("src", browser.runtime.getURL("non_web_accessible.html"));
+    document.body.appendChild(failToLoadIframe);
+
+    let iframe = document.createElement("iframe");
+    iframe.setAttribute("src", browser.runtime.getURL("content_script_iframe.html"));
+    document.body.appendChild(iframe);
+  }
+
+  function contentScriptIframe() {
+    let manifest = browser.runtime.getManifest();
+    let availableAPIs = Object.keys(browser);
+
+    browser.runtime.sendMessage({
+      name: "content-script-iframe-loaded",
+      availableAPIs,
+      manifest,
+    });
+  }
+
+  let extensionData = {
+    manifest: {
+      content_scripts: [
+        {
+          "matches": ["http://mochi.test/*/file_sample.html"],
+          "js": ["content_script.js"],
+          "run_at": "document_end",
+        },
+      ],
+      "web_accessible_resources": [
+        "content_script_iframe.html",
+      ],
+    },
+
+    background: "(" + backgroundScript + ")()",
+
+    files: {
+      "content_script.js": "new " + contentScript,
+      "content_script_iframe.html": document.querySelector("#test-asset").textContent,
+      "content_script_iframe.js": "new " + contentScriptIframe,
+      "non_web_accessible.html": "<h1>This should not be loaded in an iframe inside a content URL</h1>",
+    },
+  };
+
+  let extension = ExtensionTestUtils.loadExtension(extensionData);
+
+  let contentScriptIframeCreatedPromise = new Promise(resolve => {
+    extension.onMessage("content-script-iframe-loaded", () => { resolve(); });
+  });
+
+  yield extension.startup();
+  info("extension loaded");
+
+  let win = window.open("file_sample.html");
+
+  let awaitSecurityError = new Promise(resolve => {
+    let chromeScript = SpecialPowers.loadChromeScript(
+      SimpleTest.getTestFileURL("file_ext_collect_security_errors.js"));
+
+    chromeScript.addMessageListener("security-error-message", resolve);
+  });
+
+  yield Promise.all([waitForLoad(win), contentScriptIframeCreatedPromise]);
+  info("content script privileged iframe loaded and executed");
+
+  info("testing APIs availability once the extension is unloaded...");
+
+  let iframeWindow;
+
+  for (let currentIframeIdx of [0, 1]) {
+    let currentIframeWindow = SpecialPowers.wrap(win)[currentIframeIdx];
+    let iframeLocation = currentIframeWindow.location.toString();
+
+    if (iframeLocation.match(/content_script_iframe\.html$/)) {
+      iframeWindow = currentIframeWindow;
+    }
+
+    if (iframeLocation.match(/non_web_accessible\.html$/)) {
+      ok(false, "non_web_accessible.html should not be loaded in an web page iframe");
+    }
+  }
+
+  const SECURITY_ERROR_REGEXP = /Security Error: Content at (.*) may not load or link to (.*)/;
+  let securityErrorMessage = yield awaitSecurityError;
+  let matchSecurityError = securityErrorMessage.message.match(SECURITY_ERROR_REGEXP);
+
+  if (matchSecurityError) {
+    ok(/non_web_accessible\.html/.test(matchSecurityError[2]), "non web accesible URLs are blocked " +
+                                                               "and emit the expected security errors");
+  } else {
+    ok(false, "expected security error not found");
+  }
+
+  ok(iframeWindow, "content script enabled iframe found");
+  iframeWindow.eval("window.GET_MANIFEST = browser.runtime.getManifest.bind(null);");
+
+  let expectedManifest = iframeWindow.eval("GET_MANIFEST()");
+  ok(!!expectedManifest.content_scripts, "GET_MANIFEST() returns manifest data before extension unload");
+
+  yield extension.unload();
+  info("extension unloaded");
+
+  let ww = SpecialPowers.Cu.waiveXrays(iframeWindow);
+  let isDeadWrapper = SpecialPowers.Cu.isDeadWrapper(ww.browser);
+  ok(!isDeadWrapper, "the API object should not be a dead object");
+
+  let manifest;
+  let manifestException;
+
+  try {
+    manifest = iframeWindow.eval("browser.runtime.getManifest()");
+  } catch (e) {
+    manifestException = e;
+  }
+
+  ok(!manifest, "manifest should be undefined");
+
+  const BROWSER_RUNTIME_UNDEFINED_EXCEPTION = "TypeError: browser.runtime is undefined";
+  is(manifestException && manifestException.toString(), BROWSER_RUNTIME_UNDEFINED_EXCEPTION,
+     `expected BROWSER_RUNTIME_UNDEFINED_EXCEPTION exception received`);
+
+  let getManifest;
+  let getManifestException;
+
+  try {
+    getManifest = iframeWindow.eval("GET_MANIFEST()");
+  } catch (e) {
+    getManifestException = e;
+  }
+
+  ok(!getManifest, "getManifest should be undefined");
+
+  const DESTROYED_EXT_METHOD_EXCEPTION = "TypeError: GET_MANIFEST is not a function";
+  is(getManifestException && getManifestException.toString(), DESTROYED_EXT_METHOD_EXCEPTION,
+     `expected DESTROYED_EXT_METHOD_EXCEPTION exception received`);
+
+  win.close();
+});
+</script>
+
+</body>
+</html>

