# HG changeset patch
# User Luca Greco <luca.greco@alcacoop.it>

Bug 1218364 - windowless browser windows should not crash on Troubleshoot (r=billm)

---
 gfx/layers/client/ClientLayerManager.cpp           |  1 +
 gfx/tests/browser/browser.ini                      |  4 ++
 .../browser_windowless_troubleshoot_crash.js       | 45 ++++++++++++++++++++++
 gfx/tests/moz.build                                |  1 +
 toolkit/modules/Troubleshoot.jsm                   |  3 +-
 5 files changed, 53 insertions(+), 1 deletion(-)
 create mode 100644 gfx/tests/browser/browser.ini
 create mode 100644 gfx/tests/browser/browser_windowless_troubleshoot_crash.js

diff --git a/gfx/layers/client/ClientLayerManager.cpp b/gfx/layers/client/ClientLayerManager.cpp
index e4cd768..8bfea1d 100644
--- a/gfx/layers/client/ClientLayerManager.cpp
+++ b/gfx/layers/client/ClientLayerManager.cpp
@@ -755,16 +755,17 @@ ClientLayerManager::ClearLayer(Layer* aLayer)
     ClearLayer(child);
   }
 }
 
 void
 ClientLayerManager::GetBackendName(nsAString& aName)
 {
   switch (mForwarder->GetCompositorBackendType()) {
+    case LayersBackend::LAYERS_NONE: aName.AssignLiteral("None"); return;
     case LayersBackend::LAYERS_BASIC: aName.AssignLiteral("Basic"); return;
     case LayersBackend::LAYERS_OPENGL: aName.AssignLiteral("OpenGL"); return;
     case LayersBackend::LAYERS_D3D9: aName.AssignLiteral("Direct3D 9"); return;
     case LayersBackend::LAYERS_D3D11: {
 #ifdef XP_WIN
       if (gfxWindowsPlatform::GetPlatform()->IsWARP()) {
         aName.AssignLiteral("Direct3D 11 WARP");
       } else {
diff --git a/gfx/tests/browser/browser.ini b/gfx/tests/browser/browser.ini
new file mode 100644
index 0000000..0a1902f
--- /dev/null
+++ b/gfx/tests/browser/browser.ini
@@ -0,0 +1,4 @@
+[DEFAULT]
+support-files =
+
+[browser_windowless_troubleshoot_crash.js]
diff --git a/gfx/tests/browser/browser_windowless_troubleshoot_crash.js b/gfx/tests/browser/browser_windowless_troubleshoot_crash.js
new file mode 100644
index 0000000..77293b8
--- /dev/null
+++ b/gfx/tests/browser/browser_windowless_troubleshoot_crash.js
@@ -0,0 +1,45 @@
+let { Services } = Cu.import("resource://gre/modules/Services.jsm", {});
+
+add_task(function* test_windowlessBrowserTroubleshootCrash() {
+  let webNav = Services.appShell.createWindowlessBrowser(false);
+
+  let onLoaded = new Promise((resolve, reject) => {
+    let docShell = webNav.QueryInterface(Ci.nsIInterfaceRequestor)
+                         .getInterface(Ci.nsIDocShell);
+    let listener = {
+      observe(contentWindow, topic, data) {
+        let observedDocShell = contentWindow.QueryInterface(Ci.nsIInterfaceRequestor)
+                                            .getInterface(Ci.nsIWebNavigation)
+                                            .QueryInterface(Ci.nsIDocShellTreeItem)
+                                            .sameTypeRootTreeItem
+                                            .QueryInterface(Ci.nsIDocShell);
+          if (docShell === observedDocShell) {
+            Services.obs.removeObserver(listener, "content-document-global-created", false);
+            resolve();
+          }
+        }
+    }
+    Services.obs.addObserver(listener, "content-document-global-created", false);
+  });
+  webNav.loadURI("about:blank", 0, null, null, null);
+
+  yield onLoaded;
+
+  let winUtils = webNav.document.defaultView.
+                        QueryInterface(Ci.nsIInterfaceRequestor).
+                        getInterface(Ci.nsIDOMWindowUtils);
+  is(winUtils.layerManagerType, "None", "windowless browser's layerManagerType should be 'None'");
+
+  ok(true, "not crashed");
+
+  // TODO: is this test better moved elsewhere in the source tree?
+  var Troubleshoot = Cu.import("resource://gre/modules/Troubleshoot.jsm", {}).Troubleshoot;
+  var data = yield new Promise((resolve, reject) => {
+    Troubleshoot.snapshot((data) => {
+      resolve(data);
+    });
+  });
+
+  is(data.graphics.numAcceleratedWindows, 0, "windowless browser window should not be counted as an accelerated window");
+  is(data.graphics.windowLayerManagerType, "None", "windowless browser window should not be recognized as windowLayerManagerType 'None'");
+});
diff --git a/gfx/tests/moz.build b/gfx/tests/moz.build
index b985130..696ca9a 100644
--- a/gfx/tests/moz.build
+++ b/gfx/tests/moz.build
@@ -1,8 +1,9 @@
 # -*- Mode: python; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 40 -*-
 # vim: set filetype=python:
 # This Source Code Form is subject to the terms of the Mozilla Public
 # License, v. 2.0. If a copy of the MPL was not distributed with this
 # file, You can obtain one at http://mozilla.org/MPL/2.0/.
 
 XPCSHELL_TESTS_MANIFESTS += ['unit/xpcshell.ini']
 MOCHITEST_MANIFESTS += ['mochitest/mochitest.ini']
+BROWSER_CHROME_MANIFESTS += ['browser/browser.ini']
diff --git a/toolkit/modules/Troubleshoot.jsm b/toolkit/modules/Troubleshoot.jsm
index 159bc66..5474682 100644
--- a/toolkit/modules/Troubleshoot.jsm
+++ b/toolkit/modules/Troubleshoot.jsm
@@ -314,17 +314,18 @@ var dataProviders = {
       try {
         data.windowLayerManagerType = winUtils.layerManagerType;
         data.windowLayerManagerRemote = winUtils.layerManagerRemote;
         data.supportsHardwareH264 = winUtils.supportsHardwareH264Decoding;
       }
       catch (e) {
         continue;
       }
-      if (data.windowLayerManagerType != "Basic")
+      // if layerManagerType equals Basic or None, it doesn't count as accelerated window
+      if (["Basic", "None"].indexOf(data.windowLayerManagerType) < 0)
         data.numAcceleratedWindows++;
     }
 
     if (!data.numAcceleratedWindows && gfxInfo) {
       let win = AppConstants.platform == "win";
       let feature = win ? gfxInfo.FEATURE_DIRECT3D_9_LAYERS :
                           gfxInfo.FEATURE_OPENGL_LAYERS;
       data.numAcceleratedWindowsMessage = statusMsgForFeature(feature);

